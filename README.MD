# Calendar

Version: 2.0.

Author: Andrei Kladkevich

2024

## Бизнес-требования
Сервис производственного календаря.

1) Функциональные требования:
1.1. Сервис должен с настроенной периодичностью выполнять синхронизацию данных производственного календаря из внешнего источника https://xmlcalendar.ru/, с сохранением изменений в БД.
1.2. При наличии изменений, должно формироваться уведомление через брокер сообщений.
1.3. Сервис должен предоставлять REST API со следующими эндпоинтами:
- Запуск синхронизации по запросу
- Информация о последней синхронизации: дата, время и результат синхронизации, исходный текст сообщения (если было получено)
- Получение информации о типе дня на заданную дату
- Получение информации о переносах рабочих дней
- Получение информации о количестве рабочих и нерабочих дней в году

2) Иные требования:
2.1. Репозиторий должен содержать Dockerfile и docker-compose файл с описанием внешних приложений (DB, брокер сообщений)

3) Компоненты:
3.1. Сервис загрузки производственного календаря
3.2. DB
3.3. AMQ / RabbitMq

## Реализация

### Модель данных
Сущности.

CalendarOriginal - записи по календарю в исходном виде.
Атрибуты:
  id - идентификатор записи
  country - страна календаря
  year - год календаря
  dateTime - дата создания записи
  status - статус записи (из справочника RecordStatus)
  isArchived - признак архивной записи
  data - данные календаря в исходном виде
Индексы:
  country, year, isArchived
  
RecordStatus - статусы записи по календарю.
Значения:
  NEW - новая запись
  PROCESSED - обработанная запись
  
CalendarFinalMonth - месяцы итогового (обработанного) календаря
Атрибуты:
  id - идентификатор записи
  country - страна календаря
  year - год календаря
  month - месяц календаря
  days - данные ключа days по конкретному месяцу
  dateTime - дата создания записи
  status - статус записи (из справочника RecordStatus)
  isArchived - признак архивной записи
Индексы:
  country, year, month, isArchived

CalendarFinalTransition - переносы итогового календаря
Атрибуты:
  id - идентификатор записи
  country - страна календаря
  year - год календаря
  dayFrom - дата, с которой переносится рабочий день
  dayTo - дата, на которую переносится рабочий день
  dateTime - дата создания записи
  isArchived - признак архивной записи
Индексы:
  country, year, dayFrom, isArchived

CalendarFinalStatistic - статистика итогового календаря
Атрибуты:
  id - идентификатор записи
  country - страна календаря
  year - год календаря
  workdays - количество рабочих дней в году
  holidays - количество выходных дней в году
  dateTime - дата создания записи
  isArchived - признак архивной записи
Индексы:
  country, year, isArchived

### Use Cases
Описание - в файле CalendarUseCases.txt.

### Описание сервисов
1. Сервис получения данных из внешнего источника: LoadSourceDataService
2. Сервис для работы с данными календаря в исходном виде: CalendarOriginalService
3. Сервис для работы с данными итогового календаря (в виде, адаптированном под приложение): CalendarFinalService
4. Сервис для расчета типа дня: DayTypeService
5. Сервис для предоставления информации по календарю: CalendarResourceService

### Концепция архитектуры
Данные календаря в исходном виде сохраняются в БД в одну таблицу.
Производится обработка записей: парсится исходный текст календаря, данные по сегментам записываются в соответствующие итоговые таблицы.
Данные итоговых таблиц используются для предоставления различной информации по календарю (тип дня, переносы, статистика).

При обработке записей как по исходному календарю, так и по итоговому, предварительно анализируется наличие актуальной записи.
Если запись имеется, повторное сохранение не производится. Если не имеется, то производится сохранение актуальной записи.
При этом, неактуальные существующие записи помечаются как архивные (если они имелись).

### Состав внешних используемых приложений
1. СУБД PostgreSQL.
2. Брокер сообщений RabbitMQ.
3. Инструмент мониторинга Prometheus.
4. Платформа визуализации мониторинга Grafana.

### Статус реализации
Реализовано:
1. Планировщик для загрузки календаря из внешнего источника. Точка входа: класс CalendarOriginalScheduler, метод loadCalendarOriginalAll.
2. Использование RabbitMQ для отправки/получения сообщений по загрузке данных календаря. Описание очередей - в файле RabbitConfig.java.
3. REST API для получения информации о типе дня на заданную дату. Точка входа: класс CalendarResourceController, метод getDayType.
4. docker-compose файл с описанием внешних приложений (Postgres, RabbitMQ).
5. docker-файл Dockerfile.
6. REST API для загрузки календаря из внешнего источника. Точка входа: класс CalendarController, метод loadCalendar.
7. REST API с информацией о последней синхронизации. Точка входа: класс CalendarController, метод getLastUpdate.
8. REST API с информацией о переносах рабочих дней. Точка входа: класс CalendarController, метод getTransitions.
9. REST API с информацией о количестве рабочих и нерабочих дней в году. Точка входа: класс CalendarController, метод getStatistic.
10. Реализован мониторинг метрик приложения (состав метрик - см. ниже).
11. Реализован CI/CD процесс через Github.

### Настройки приложения и внешних приложений (файл application.yml)

#### Приложение Calendar
1. Основная часть URL календаря: app.calendar.url
2. Список стран календаря: app.calendar.countryList
3. Список лет календаря: app.calendar.yearList
4. Интервал загрузки календаря в миллисекундах: app.calendar.loadCalendarInterval

#### СУБД PostgreSQL
1. Имя пользователя БД Postgres: spring.datasource.username
2. Пароль пользователя БД Postgres: spring.datasource.password

#### Брокер сообщений RabbitMQ
1. Название обменника: rabbitmq.exchange
2. Ключ для роутинга очереди информационных сообщений по исходному календарю: rabbitmq.routing.originalInfoKey
3. Ключ для роутинга очереди сообщений с ошибками по исходному календарю: rabbitmq.routing.originalErrorKey
4. Ключ для роутинга очереди информационных сообщений по итоговому календарю: rabbitmq.routing.finalInfoKey
5. Ключ для роутинга очереди сообщений с ошибками по итоговому календарю: rabbitmq.routing.finalErrorKey
6. Очередь информационных сообщений по исходному календарю: rabbitmq.queue.originalInfo
7. Очередь сообщений с ошибками по исходному календарю: rabbitmq.queue.originalError
8. Очередь информационных сообщений по итоговому календарю: rabbitmq.queue.finalInfo
9. Очередь сообщений с ошибками по итоговому календарю: rabbitmq.queue.finalError

### Описание эндпоинтов
1. Запуск синхронизации по запросу: /calendar-resource/load-calendar
2. Информация о последней синхронизации: /calendar-resource/get-last-update
3. Получение информации о типе дня на заданную дату: /calendar-resource/get-day-type
4. Получение информации о переносах рабочих дней: /calendar-resource/get-transitions
5. Получение информации о количестве рабочих и нерабочих дней в году: /calendar-resource/get-statistic

### Запуск приложения
Приложение можно запустить с помощью следующей команды:
docker-compose up.

### Метрики приложения
1. Мониторинг вызова методов контроллера CalendarController: calendar_controller_call_count.
2. Мониторинг генерации внутренних исключений: calendar_internal_exception_count.
3. Мониторинг времени загрузки календаря: calendar_load_execution_time.

### Ссылки на ресурсы приложения и используемых инструментов
(при запуске с локальной машины; при запуске на удаленном сервере localhost следует заменить на IP-адрес хоста)
1. Swagger UI (для вызова API через браузер): http://localhost:8080 
1. RabbitMQ: http://localhost:15672
2. Actuator: http://localhost:8080/actuator
3. Prometheus: http://localhost:8080/actuator/prometheus
4. Grafana: http://localhost:3000